<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#9EDFA7"><meta name="author" content="梓喵唯一指定老公"><meta name="copyright" content="梓喵唯一指定老公"><meta name="generator" content="Hexo 5.4.0"><meta name="theme" content="hexo-theme-yun"><title>Azusa</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#9EDFA7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"azunyan.cn","root":"/","title":["azusaの轻音社"],"version":"1.6.2","mode":"light","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}.","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"/data/sentences.json"},"fireworks":{"colors":["241, 158, 194","294, 204, 226","242, 156, 177","245, 212, 217"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><link rel="stylesheet" href="/css/latofonts.css"><script src="//at.alicdn.com/t/font_1763255_y9klqsvfr3b.js" async></script><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-1LL0D86CY9"></script><script>if (CONFIG.hostname === location.hostname) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-1LL0D86CY9');
}</script><script data-ad-client="ca-pub-2245427233262012" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-M9KWR9L');</script><!-- End Google Tag Manager --><meta name="description" content="事务事务为用户定义的操作序列，这些操作需要满足ACID  A：原子性。 事务中的操作要么全部成功，要么全部失败回滚 C：一致性。 数据库从一个一致性状态到另一个一致性状态 I：隔离性。事务之间相互隔离，不能被其他事务的操作干扰 D：持久性。事务一旦被提交，对数据库的影响是永久性的  事务状态 active：当事务对应的数据库操作处于执行过程中，则为活动状态 partly commited：事务中最">
<meta property="og:type" content="article">
<meta property="og:title" content="Azusa">
<meta property="og:url" content="https://azunyan.cn/2022/02/22/%E6%95%B0%E6%8D%AE%E5%BA%93_%E5%85%AB%E8%82%A1/index.html">
<meta property="og:site_name" content="Azusa">
<meta property="og:description" content="事务事务为用户定义的操作序列，这些操作需要满足ACID  A：原子性。 事务中的操作要么全部成功，要么全部失败回滚 C：一致性。 数据库从一个一致性状态到另一个一致性状态 I：隔离性。事务之间相互隔离，不能被其他事务的操作干扰 D：持久性。事务一旦被提交，对数据库的影响是永久性的  事务状态 active：当事务对应的数据库操作处于执行过程中，则为活动状态 partly commited：事务中最">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e41d5dcb3d704a60a3a5ded50593ee86~tplv-k3u1fbpfcp-watermark.awebp">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e0ad4a317904426cac3903a89a293917~tplv-k3u1fbpfcp-watermark.awebp">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ccde9c179fae491484bfffb3d8e4f521~tplv-k3u1fbpfcp-watermark.awebp">
<meta property="og:image" content="d:/Azusa/Dsektop/记录/数据库_八股.assets/未命名文件.png">
<meta property="article:published_time" content="2022-02-22T12:49:30.884Z">
<meta property="article:modified_time" content="2022-02-09T12:42:23.490Z">
<meta property="article:author" content="梓喵唯一指定老公">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e41d5dcb3d704a60a3a5ded50593ee86~tplv-k3u1fbpfcp-watermark.awebp"></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="梓喵唯一指定老公"><img width="96" loading="lazy" src="/images/1.jpg" alt="梓喵唯一指定老公"></a><div class="site-author-name"><a href="/about/">梓喵唯一指定老公</a></div><span class="site-name">Azusa</span><sub class="site-subtitle">现充，给我爆炸吧！</sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">9</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">3</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">3</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="留言板"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-clipboard-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:你的邮箱" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://weibo.com/" title="微博" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=411240608" title="网易云音乐" target="_blank" style="color:#C20C0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/25764438" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:red"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-open-arm-line"></use></svg></a><a class="links-item hty-icon-button" href="/girls/" title="喜欢的女孩子" style="color:hotpink"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-heart-line"></use></svg></a></div></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">事务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%8A%B6%E6%80%81"><span class="toc-number">1.0.0.1.</span> <span class="toc-text">事务状态</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#InnoDB%E5%92%8CMyISAM"><span class="toc-number">2.</span> <span class="toc-text">InnoDB和MyISAM</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MyISAM"><span class="toc-number">2.1.</span> <span class="toc-text">MyISAM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InnoDB"><span class="toc-number">2.2.</span> <span class="toc-text">InnoDB</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95"><span class="toc-number">3.</span> <span class="toc-text">索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#InnoDB-1"><span class="toc-number">3.0.1.</span> <span class="toc-text">InnoDB</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%81%9A%E7%B0%87%E7%B4%A2%E5%BC%95"><span class="toc-number">3.0.1.1.</span> <span class="toc-text">聚簇索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%85%E5%8A%A9%E7%B4%A2%E5%BC%95"><span class="toc-number">3.0.1.2.</span> <span class="toc-text">辅助索引</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MyISAM-1"><span class="toc-number">3.0.2.</span> <span class="toc-text">MyISAM</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95-%E6%9C%80%E5%B7%A6%E5%8C%B9%E9%85%8D-%E7%B4%A2%E5%BC%95%E4%B8%8B%E6%8E%A8"><span class="toc-number">3.1.</span> <span class="toc-text">联合索引 最左匹配 索引下推</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MVCC"><span class="toc-number">4.</span> <span class="toc-text">MVCC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ReadView"><span class="toc-number">4.0.0.1.</span> <span class="toc-text">ReadView</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9A%94%E7%A6%BB%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.</span> <span class="toc-text">隔离模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BA%E7%8E%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">5.0.1.</span> <span class="toc-text">出现的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%84%8F%E8%AF%BB"><span class="toc-number">5.0.1.1.</span> <span class="toc-text">脏读</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB"><span class="toc-number">5.0.1.2.</span> <span class="toc-text">不可重复读</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%BB%E8%AF%BB"><span class="toc-number">5.0.1.3.</span> <span class="toc-text">幻读</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MySql%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">5.0.2.</span> <span class="toc-text">MySql隔离级别</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%94%81"><span class="toc-number">6.</span> <span class="toc-text">锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%8C%E9%94%81"><span class="toc-number">6.0.1.</span> <span class="toc-text">行锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E9%94%81"><span class="toc-number">6.0.1.1.</span> <span class="toc-text">记录锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%B4%E9%9A%99%E9%94%81"><span class="toc-number">6.0.1.2.</span> <span class="toc-text">间隙锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%B4%E9%94%AE%E9%94%81"><span class="toc-number">6.0.1.3.</span> <span class="toc-text">临键锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E9%94%81"><span class="toc-number">6.0.2.</span> <span class="toc-text">表锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%A2%9E%E9%94%81"><span class="toc-number">6.0.2.1.</span> <span class="toc-text">自增锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#S%E3%80%81X%E3%80%81IS%E3%80%81IX%E9%94%81"><span class="toc-number">6.0.3.</span> <span class="toc-text">S、X、IS、IX锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E9%94%81"><span class="toc-number">6.0.3.1.</span> <span class="toc-text">共享锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%92%E4%BB%96%E9%94%81"><span class="toc-number">6.0.3.2.</span> <span class="toc-text">排他锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%84%8F%E5%90%91%E9%94%81"><span class="toc-number">6.0.3.3.</span> <span class="toc-text">意向锁</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undolog%E3%80%81redolog"><span class="toc-number">7.</span> <span class="toc-text">undolog、redolog</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#redolog"><span class="toc-number">7.0.0.1.</span> <span class="toc-text">redolog</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undolog"><span class="toc-number">7.0.0.2.</span> <span class="toc-text">undolog</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84"><span class="toc-number">8.</span> <span class="toc-text">主从架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">8.1.</span> <span class="toc-text">主从复制</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sql%E4%BC%98%E5%8C%96"><span class="toc-number">9.</span> <span class="toc-text">sql优化</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://azunyan.cn/2022/02/22/%E6%95%B0%E6%8D%AE%E5%BA%93_%E5%85%AB%E8%82%A1/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="梓喵唯一指定老公"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Azusa"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"></h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="Created: 2022-02-22 20:49:30" itemprop="dateCreated datePublished" datetime="2022-02-22T20:49:30+08:00">2022-02-22</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="Modified: 2022-02-09 20:42:23" itemprop="dateModified" datetime="2022-02-09T20:42:23+08:00">2022-02-09</time></div><div class="post-classify"></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#9EDFA7;"><h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><p>事务为用户定义的操作序列，这些操作需要满足ACID</p>
<ul>
<li>A：原子性。 事务中的操作要么全部成功，要么全部失败回滚</li>
<li>C：一致性。 数据库从一个一致性状态到另一个一致性状态</li>
<li>I：隔离性。事务之间相互隔离，不能被其他事务的操作干扰</li>
<li>D：持久性。事务一旦被提交，对数据库的影响是永久性的</li>
</ul>
<h4 id="事务状态"><a href="#事务状态" class="headerlink" title="事务状态"></a>事务状态</h4><ol>
<li>active：当事务对应的数据库操作处于执行过程中，则为<code>活动</code>状态</li>
<li>partly commited：事务中最后一个操作执行完成，但还未将变更刷新到磁盘时，处于<code>部分提交</code> 状态</li>
<li>failed：事务处于活动或者部分提交状态时，由于某些错误导致事务无法继续执行，处于<code>失败</code>状态</li>
<li>aborted：事务处于失败状态，且回滚操作执行完毕，数据恢复到事务执行前的状态，此时事务处于<code>中止</code>状态</li>
<li>commited：事务处于部分提交状态，且将修改后的数据同步到磁盘后，此时事务处于<code>提交</code>状态</li>
</ol>
<h1 id="InnoDB和MyISAM"><a href="#InnoDB和MyISAM" class="headerlink" title="InnoDB和MyISAM"></a>InnoDB和MyISAM</h1><h2 id="MyISAM"><a href="#MyISAM" class="headerlink" title="MyISAM"></a>MyISAM</h2><p>myisam不支持事务，只有表锁没有行锁，表不支持外键。存有表的总行数，count运算更快，适合查询频繁，不适合增删改要求高的。索引实现为索引为索引，数据为数据，索引文件都为二级索引（InnoDB标准）。可以被压缩后执行查询操作。</p>
<h2 id="InnoDB"><a href="#InnoDB" class="headerlink" title="InnoDB"></a>InnoDB</h2><p>innodb支持事务，是Mysql的默认引擎，表基于聚簇索引建立，索引和数据在一起，支持表锁和行锁，支持外键，以事务为基本单位运行。支持AUTO_INCREMENT属性</p>
<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><h3 id="InnoDB-1"><a href="#InnoDB-1" class="headerlink" title="InnoDB"></a>InnoDB</h3><p><strong>索引即数据，数据即索引</strong></p>
<h4 id="聚簇索引"><a href="#聚簇索引" class="headerlink" title="聚簇索引"></a>聚簇索引</h4><ul>
<li>索引页目录中存放主键和页号，叶子节点存放每个记录的完整数据</li>
<li>表的根目录页号不变</li>
<li>针对主键进行查询，直接查询即可得到数据</li>
</ul>
<h4 id="辅助索引"><a href="#辅助索引" class="headerlink" title="辅助索引"></a>辅助索引</h4><ul>
<li>页目录存放索引字段、主键（保证唯一，便于插入）和页号，叶子节点存放索引字段、主键</li>
<li>查询时，先在辅助索引b+数中查找到对应主键值，回表。若条件不唯一，则重复多次。</li>
</ul>
<h3 id="MyISAM-1"><a href="#MyISAM-1" class="headerlink" title="MyISAM"></a>MyISAM</h3><p><strong>索引即索引，数据即数据</strong></p>
<ul>
<li>索引页目录中存放主键和对应的行号（如果是变长格式则为偏移量），所有的记录按照插入顺序存放在 数据文件 中。</li>
<li>相当于InnoDB的辅助索引</li>
</ul>
<h2 id="联合索引-最左匹配-索引下推"><a href="#联合索引-最左匹配-索引下推" class="headerlink" title="联合索引 最左匹配 索引下推"></a>联合索引 最左匹配 索引下推</h2><ul>
<li><p>联合索引：通过多个字段建立索引，按照顺序排序</p>
</li>
<li><p>最左匹配：当查询条件中含有联合索引的最左边字段时采用索引，若是没有最左字段，不进行索引查询，全表扫描。因为b+树是按照第一个（最左边）的字段建立索引树，没有最左索引无法知道从哪开始查询。</p>
</li>
<li><p>索引下推：在使用联合索引时，没有索引下推时，<code>SELECT * FROM xxx WHERE name like &quot;赵%&quot; and age = 22</code>(此时已建立name、age联合索引)会先查找到name为赵xx的而忽略age字段，在回表进行查询该记录判断age。索引下推不会忽略age字段，先行筛选不符合条件的记录，之后才回表。减少了回表次数，避免多次扫描磁盘读取数据。</p>
</li>
</ul>
<h1 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h1><p>MVCC：多版本并发控制，即通过维护数据版本，解决并发情况下的读一致性问题</p>
<p><code>innodb</code>中保存当前系统版本号，每当有事务创建，版本号都+1，并赋值给新的事务作为事务的版本号。</p>
<p>表中的每行数据实际上隐藏了两列字段：事务id（<code>trx_id</code>）和回滚指针（<code>roll_pointer</code>）</p>
<ol>
<li><code>trx_id</code>：事务id。每次修改某行记录时，都会把该事务的id（版本号）赋值给<code>trx_id</code>隐藏列</li>
<li><code>roll_pointer</code>：回滚指针。每次修改某行记录时，都会把<code>undo</code>日志地址赋值给<code>roll_pointer</code>隐藏列</li>
</ol>
<p>e.g : </p>
<p>假设<code>hero</code>表中只有一行记录，当时插入的事务id为80。此时，该条记录的示例图如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e41d5dcb3d704a60a3a5ded50593ee86~tplv-k3u1fbpfcp-watermark.awebp" alt="mvcc1" loading="lazy"></p>
<p>假设之后两个事务<code>id</code>分别为<code>100</code>、<code>200</code>的事务对这条记录进行<code>UPDATE</code>操作，操作流程如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e0ad4a317904426cac3903a89a293917~tplv-k3u1fbpfcp-watermark.awebp" alt="mvcc2" loading="lazy"></p>
<p>由于每次变动都会先把<code>undo</code>日志记录下来，并用<code>roll_pointer</code>指向<code>undo</code>日志地址。因此可以认为，<strong>对该条记录的修改日志串联起来就形成了一个<code>版本链</code>，版本链的头节点就是当前记录最新的值</strong>。如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ccde9c179fae491484bfffb3d8e4f521~tplv-k3u1fbpfcp-watermark.awebp" alt="mvcc3" loading="lazy"></p>
<h4 id="ReadView"><a href="#ReadView" class="headerlink" title="ReadView"></a>ReadView</h4><p>如果当前数据库的隔离级别是<code>未提交读</code>，那么只需要每次读取最新的数据就行。如果是<code>串行化</code>，事务之间都是加锁进行，不存在读不一致的问题。对于<code>可重复读</code>、<code>读已提交</code>，就需要遍历版本链的每一条记录，依次判断对当前事务是否可见，直到找到为止或遍历完。<code>Innodb</code>通过<code>ReadView</code>实现了该功能。<code>ReadView</code>主要包含：</p>
<ul>
<li><code>m_ids</code>：表示在生成<code>ReadView</code>时当前系统中活跃的读写事务的事务id列表。</li>
<li><code>min_trx_id</code>：表示在生成<code>ReadView</code>时当前系统中活跃的读写事务中最小的事务id，也就是<code>m_ids</code>中的最小值。</li>
<li><code>max_trx_id</code>：表示生成<code>ReadView</code>时系统中应该分配给<strong>下一个事务的id值</strong>。</li>
<li><code>creator_trx_id</code>：表示生成该<code>ReadView</code>事务的事务id。</li>
</ul>
<p>ReadView在读取前生成，基于ReadView可以通过以下步骤判断是否对当前事务可见：</p>
<ol>
<li>如果被访问版本的<code>trx_id</code>属性值与<code>ReadView</code>中的<code>creator_trx_id</code>值相同，意味着当前事务在访问它自己修改过的记录，所以该版本可以被当前事务访问。</li>
<li>如果被访问版本的<code>trx_id</code>属性值小于<code>ReadView</code>中的<code>min_trx_id</code>值，表明生成该版本的事务在当前事务生成<code>ReadView</code>前已经提交，所以该版本可以被当前事务访问。</li>
<li>如果被访问版本的<code>trx_id</code>属性值大于或等于<code>ReadView</code>中的<code>max_trx_id</code>值，表明生成该版本的事务在当前事务生成<code>ReadView</code>后才开启，所以该版本不可以被当前事务访问。</li>
<li>如果被访问版本的<code>trx_id</code>属性值在<code>ReadView</code>的<code>min_trx_id</code>和<code>max_trx_id</code>之间，那就需要判断一下<code>trx_id</code>属性值是不是在<code>m_ids</code>列表中，如果在，说明创建<code>ReadView</code>时生成该版本的事务还是活跃的，该版本不可以被访问；如果不在，说明创建<code>ReadView</code>时生成该版本的事务已经被提交，该版本可以被访问。</li>
</ol>
<h1 id="隔离模式"><a href="#隔离模式" class="headerlink" title="隔离模式"></a>隔离模式</h1><h3 id="出现的问题"><a href="#出现的问题" class="headerlink" title="出现的问题"></a>出现的问题</h3><h4 id="脏读"><a href="#脏读" class="headerlink" title="脏读"></a>脏读</h4><p>一个事务读取到另一个事务未提交的修改。</p>
<h4 id="不可重复读"><a href="#不可重复读" class="headerlink" title="不可重复读"></a>不可重复读</h4><p>在读取的时候，第一次读取到的数据和后续读取到的数据不一致（由于读取到别的事务对数据的已提交的更改），大部分情况以最后一次查询为主，但是在某些情况需要保证读的数据相同</p>
<h4 id="幻读"><a href="#幻读" class="headerlink" title="幻读"></a>幻读</h4><p>一个事务对一批数据的更改，此时另一个事务对修改的某数据进行更改。此时查看数据库，发现该数据未被修改。</p>
<p>e.g T1对某一列全部更改为2，此时T2向表中<strong>插入</strong>一行数据，且该列数据为1，并提交。此时查看数据库发现有一行没有被改为2，仿佛出现幻觉</p>
<blockquote>
<p>不可重复读和幻读的区别在于，不可重复读 读取到了其他事务修改或删除的数据，幻读 读取到的是其他事务新插入的数据</p>
</blockquote>
<h3 id="MySql隔离级别"><a href="#MySql隔离级别" class="headerlink" title="MySql隔离级别"></a>MySql隔离级别</h3><ol>
<li>serializable 可串行化： 避免脏读、不可重复读、幻读发生</li>
<li>repeatable read 可重复读：避免脏读、不可重复读 （默认模式）</li>
<li>Read commited 读已提交：避免脏读</li>
<li>Read uncommited 读未提交：无法确保</li>
</ol>
<h1 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h1><p>MySql锁机制基本基于悲观锁实现</p>
<p><img src="D:\Azusa\Dsektop\记录\数据库_八股.assets\未命名文件.png" alt="未命名文件" loading="lazy"></p>
<h3 id="行锁"><a href="#行锁" class="headerlink" title="行锁"></a>行锁</h3><p>事务利用MVCC进行读取被称为<code>快照读</code>，所有普通的select语句在<code>READ_COMMITED</code>，<code>REPPEATABLE_READ</code>隔离级别下都是快照读。</p>
<p>但是对于锁定读，仍然要解决脏读、不可重复读、幻读的问题</p>
<blockquote>
<p>快照读和锁定读的区别：</p>
<p>快照读由select语句发起，可重复读的读就是指多次快照读的数据应该一致；</p>
<p>而锁定读可理解为当前读，一般由DML语句发起或使用枷锁读（for update），为了不丢失其他事务已提交的更新，而直接读取版本链的最新值产生的概念，所以当前读是幻读产生的必要条件（快照读不会出现幻读情况）</p>
<p>快照读可以减少加锁带来的开销</p>
</blockquote>
<p>基于索引上锁，基于<strong>索引字段</strong>的查询，命中的记录被上锁，在提交前其他事务不能被访问</p>
<p>特点： 锁冲突概率低，并发性高，会出现死锁</p>
<p>基于行锁衍生了集中算法锁：记录锁、间隙锁、临键锁</p>
<h4 id="记录锁"><a href="#记录锁" class="headerlink" title="记录锁"></a>记录锁</h4><p>必须精确命中索引 且 索引是唯一索引（主键id），锁一条记录</p>
<h4 id="间隙锁"><a href="#间隙锁" class="headerlink" title="间隙锁"></a>间隙锁</h4><p>查询条件为一定范围（大于、小于、或多个等于）</p>
<p>查询条件命中索引，且没有查询到符合条件的记录，会将查询条件的范围数据进行锁定（即使在数据库中不存在的数据也会被锁定）</p>
<p><strong>间隙锁只出现在可重复读级别以上</strong></p>
<h4 id="临键锁"><a href="#临键锁" class="headerlink" title="临键锁"></a>临键锁</h4><p>MySql默认使用的行锁，由记录锁和间隙锁实现</p>
<p>触发条件：范围查询条件命中索引，但是有匹配到记录</p>
<p>临键锁锁定的为当前记录的区间和下一个记录（不存在则为+∞）的区间。若范围的右区间命中记录，则只锁定查询区间</p>
<p>e.g</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">表中有id：1、5、7，条件为 id &gt; 1 and id &lt; 8 ,则此时锁定范围为(1,+∞),id=1可以正常被访问</span><br><span class="line">若条件为 id &gt; 1 and id &lt; 8 ,此时锁定范围为(1,7]</span><br></pre></td></tr></table></figure>

<p>why：mysql基于b+数实现，在索引树上只有1、5、7时，查询1~8，因为关键字没有8所以锁定到8到＋∞</p>
<h3 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h3><p>对于<strong>非索引字段</strong>，全表扫描，此时锁整张表。</p>
<p>特点：冲突概率高，不出现死锁，很影响性能</p>
<p>主要为IS锁、IX锁、AUTO-INC锁</p>
<h4 id="自增锁"><a href="#自增锁" class="headerlink" title="自增锁"></a>自增锁</h4><p>对于某列字段，若加上了AUTO_INCREMENT属性，则会保证自增。原理为：</p>
<ol>
<li>自增锁：在执行插入语句前加上表级别的自增锁，插入结束后立即释放。如果在执行前无法得知要插入多少条数据（<code>INSERT ... SELECT</code>），一般采用AUTO_INC锁。</li>
<li>轻量级锁：在插入语句生成AUTO_INCREMENT值前获取轻量级锁，在AUTO_INCREMENT值生成后立刻释放。如果在执行前可以确定插入多少条记录，一般使用轻量级锁。可以避免锁定表，提升性能。</li>
</ol>
<blockquote>
<p>mysql默认根据情况自动选择加锁方式，也剋以通过<code>innodb_autoinc_lock_mode</code>强制指定其中的一种</p>
</blockquote>
<h3 id="S、X、IS、IX锁"><a href="#S、X、IS、IX锁" class="headerlink" title="S、X、IS、IX锁"></a>S、X、IS、IX锁</h3><h4 id="共享锁"><a href="#共享锁" class="headerlink" title="共享锁"></a>共享锁</h4><p>S锁，事务要读取一条记录时，需要先获取该记录S锁，S锁可被多个事务同时持有，<code>SELECT .... lock in share mode</code>手工加锁</p>
<h4 id="排他锁"><a href="#排他锁" class="headerlink" title="排他锁"></a>排他锁</h4><p>X锁，事务要改动一条记录的时候，需先获取该记录的X锁，X锁在同一时刻只能被一个事务持有。自动加锁或者<code>... FOR UPDATE</code>给一行数据加X锁</p>
<h4 id="意向锁"><a href="#意向锁" class="headerlink" title="意向锁"></a>意向锁</h4><p>数据库维护的锁，用于快速判断该表中是否有记录被上锁，避免逐行遍历，提升加锁效率</p>
<p>一般来说，在给一行记录加上S锁前，会给整张表加上IS锁；在给一行记录加上X锁前，会给整张表加上IX锁</p>
<p>e.g. </p>
<p>我们要加表级别的<code>X锁</code>，这时候数据表里面如果存在行级别的<code>X锁</code>或者<code>S锁</code>的，加锁就会失败，此时直接根据<code>意向锁</code>就能知道这张表是否有行级别的<code>X锁</code>或者<code>S锁</code>。</p>
<h1 id="undolog、redolog"><a href="#undolog、redolog" class="headerlink" title="undolog、redolog"></a>undolog、redolog</h1><h4 id="redolog"><a href="#redolog" class="headerlink" title="redolog"></a>redolog</h4><p>保证在buffer pool中的还未被持久化到磁盘的数据可持久化。防止myqsl崩溃，数据为被刷新到磁盘。redolog记录了事务对数据的执行记录，确保在崩溃时回恢复对数据的修改。    </p>
<p>redolog在每一次事务提交的时候都要刷新到磁盘中（redo log buffer –&gt; redo log）</p>
<p>redolog保证了事物的一致性                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </p>
<h4 id="undolog"><a href="#undolog" class="headerlink" title="undolog"></a>undolog</h4><p>用来在事务进行修改数据时，生成反向语句记录更改。</p>
<p>undolog确保了事务的原子性，用于回滚事务，必须先于数据持久化到磁盘上</p>
<h1 id="主从架构"><a href="#主从架构" class="headerlink" title="主从架构"></a>主从架构</h1><p>读写分离，主服务器负责写，从服务器负责读。</p>
<h2 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h2><p>过程：</p>
<ol>
<li>客户发起事务，，主服务器将事务记录到<code>binlog</code>（断电可利用binlog回滚）</li>
<li>二级制日志的数据定期写入磁盘</li>
<li>从服务器可以监听主服务器的二进制文件，将发生变化的二进制文件提出到本地，放入<code>relay log</code></li>
<li>将<code>relay log</code>记录的操作读入内存，解析日志重新执行。实现主从数据同步</li>
</ol>
<p>异步复制：</p>
<ol>
<li>slave的IO进程连接上master后，请求从指定位置开始的binlog之后的日志</li>
<li>master接收到请求后，将请求的日志赋值给slave的IO进程，同时返回master端的binlog文件的位置和名字</li>
<li>slave接收到后，将日志写入relaylog中，并将读取到的日志文件名字和位置记录在<code>master-info</code>文件中，以便确定下一次读取的位置。</li>
<li>slave检测到relaylog新增内容后，解析并执行</li>
</ol>
<h1 id="sql优化"><a href="#sql优化" class="headerlink" title="sql优化"></a>sql优化</h1><ol>
<li>少用or，or的两边字段如果不是索引字段，会造成查询不走索引。可以使用union all代替</li>
<li>in和exist，in会优先执行内层表然后外层表，而exist会优先执行外层表-&gt;内层表</li>
<li>不要使用%前缀查询，会全表扫描。可以建立全文索引</li>
<li>使用explain，通过type优化</li>
</ol>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="Donate" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">我很可爱，请给我钱</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/qqpay-qrcode.png"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/qqpay-qrcode.png" alt="QQ 支付" title="QQ 支付"></a><div><span style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>梓喵唯一指定老公</li><li class="post-copyright-link"><strong>Post link: </strong><a href="https://azunyan.cn/2022/02/22/%E6%95%B0%E6%8D%AE%E5%BA%93_%E5%85%AB%E8%82%A1/" title="">https://azunyan.cn/2022/02/22/%E6%95%B0%E6%8D%AE%E5%BA%93_%E5%85%AB%E8%82%A1/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> unless otherwise stated.</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2022/02/22/%E7%BD%91%E7%BB%9C%E3%80%81%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E3%80%81linux%E3%80%81nginx%E3%80%81redis/" rel="prev" title=""><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text"></span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2021/10/09/%E5%8E%9F%E5%9E%8B%E9%AB%98%E7%BA%A7/" rel="next" title="原型高级"><span class="post-nav-text">原型高级</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>如果您有任何关于博客内容的相关讨论，欢迎前往???与我交流。</span><br></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2021 – 2022 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> 梓喵唯一指定老公</span></div><div class="live_time"><span>本博客已萌萌哒地运行</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2021-09-25T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " 天 " + passHour + " 小时 " + passMinute + " 分 " + passSecond + " 秒";
}
blog_live_time();
</script></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#9EDFA7" stroke-width="2" stroke-linecap="round"></circle></svg></a></div></body></html>